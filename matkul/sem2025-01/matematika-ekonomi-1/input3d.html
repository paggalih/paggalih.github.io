<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plotter Grafik 3D Kustom</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #1a1a1a; }
        #ui-container {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 300px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            color: white;
            z-index: 100;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h2 { margin: 0 0 10px 0; font-size: 1.2rem; color: #3498db; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: none;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: monospace;
        }
        select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 4px;
            background: #333;
            color: white;
            border: 1px solid #555;
        }
        button {
            width: 100%;
            padding: 10px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
        }
        button:hover { background-color: #219150; }
        .error-msg { color: #e74c3c; font-size: 0.8rem; margin-top: 5px; display: none; }
        .controls-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            color: rgba(255,255,255,0.5);
            pointer-events: none;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>

    <div id="ui-container">
        <h2>Input Fungsi f(x,y)</h2>
        
        <label>Pilih Contoh atau Ketik Sendiri:</label>
        <select id="exampleSelect" onchange="loadExample()">
            <option value="">-- Pilih Contoh --</option>
            <option value="x^2 + y^2">Minimum (Mangkuk)</option>
            <option value="-(x^2 + y^2)">Maksimum (Bukit)</option>
            <option value="y^2 - x^2">Saddle Point (Pelana)</option>
            <option value="sin(x) * cos(y)">Gelombang Sinus</option>
            <option value="x * y^3 - y * x^3">Monkey Saddle</option>
            <option value="sqrt(x^2 + y^2)">Kerucut Terbalik</option>
        </select>

        <label>Rumus z =</label>
        <input type="text" id="funcInput" value="y^2 - x^2" placeholder="Contoh: x^2 + y^2">
        
        <button onclick="plotUserFunction()">Visualisasikan</button>
        <div id="errorMsg" class="error-msg">Rumus tidak valid! Cek sintaks matematika Anda.</div>
    </div>

    <div class="controls-hint">
        Klik Kiri + Tahan: Putar | Scroll: Zoom | Klik Kanan: Geser
    </div>

    <!-- Three.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <!-- Math.js Library for parsing user input -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.4.4/math.min.js"></script>

    <script>
        let scene, camera, renderer, controls, mesh;
        
        function init() {
            // Setup dasar Three.js (Scene, Camera, Renderer)
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a1a1a);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(12, 10, 12);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Pencahayaan
            const ambientLight = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);
            
            const pointLight = new THREE.PointLight(0x3498db, 1, 20);
            pointLight.position.set(0, 5, 0);
            scene.add(pointLight);

            // Grid Lantai
            const gridHelper = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            scene.add(gridHelper);
            
            // Sumbu XYZ
            const axesHelper = new THREE.AxesHelper(3);
            scene.add(axesHelper);

            // Plot awal
            plotUserFunction();

            window.addEventListener('resize', onWindowResize, false);
            animate();
        }

        function loadExample() {
            const select = document.getElementById('exampleSelect');
            const input = document.getElementById('funcInput');
            if(select.value) {
                input.value = select.value;
                plotUserFunction();
            }
        }

        function plotUserFunction() {
            const inputStr = document.getElementById('funcInput').value;
            const errorMsg = document.getElementById('errorMsg');
            
            // Parsing Matematika menggunakan Math.js
            let compiledFunc;
            try {
                compiledFunc = math.compile(inputStr);
                errorMsg.style.display = 'none';
            } catch (err) {
                errorMsg.style.display = 'block';
                return;
            }

            // Hapus mesh lama jika ada
            if (mesh) {
                scene.remove(mesh);
                mesh.geometry.dispose();
                mesh.material.dispose();
            }

            // Buat Geometri
            const size = 10; // Ukuran area x,y (-5 sampai 5)
            const segments = 80; // Kepadatan jaring
            const geometry = new THREE.PlaneGeometry(size, size, segments, segments);
            
            const count = geometry.attributes.position.count;
            const positions = geometry.attributes.position.array;

            // Loop setiap vertex untuk menentukan tinggi Z
            let maxZ = -Infinity;
            let minZ = Infinity;

            for (let i = 0; i < count; i++) {
                // PlaneGeometry default ada di bidang XY.
                // Kita perlu memetakan koordinat mesh ke koordinat matematika kita
                // x mesh range: -5 sd 5
                // y mesh range: -5 sd 5
                
                const x = positions[i * 3];
                const y = positions[i * 3 + 1]; 
                
                let z = 0;
                try {
                    // Evaluasi fungsi user: f(x,y)
                    // Scope adalah variabel yang dikenal oleh parser
                    z = compiledFunc.evaluate({ x: x, y: y });
                    
                    // Batasi nilai Z agar tidak "meledak" ke infinity jika user input fungsi aneh
                    if (isNaN(z) || !isFinite(z)) z = 0;
                    
                    // Skala Z sedikit agar tidak terlalu curam untuk visualisasi
                    // (Opsional, tapi membantu melihat bentuk keseluruhan)
                    z = z * 0.3; 
                    
                } catch (e) {
                    z = 0;
                }

                // Simpan min/max untuk pewarnaan nanti (opsional)
                if (z > maxZ) maxZ = z;
                if (z < minZ) minZ = z;

                // Update posisi Z vertex
                // Dalam Three.js Z adalah depth (ke arah kamera/jauh), tapi kita rotasi mesh nanti
                positions[i * 3 + 2] = z; 
            }

            geometry.computeVertexNormals(); // Kalkulasi ulang pencahayaan

            // Material
            // Menggunakan material yang bereaksi terhadap cahaya + wireframe tipis
            const material = new THREE.MeshStandardMaterial({ 
                color: 0x00bcd4, 
                side: THREE.DoubleSide,
                metalness: 0.3,
                roughness: 0.4
            });

            mesh = new THREE.Mesh(geometry, material);
            
            // Tambahkan jaring garis hitam agar bentuk lebih jelas
            // Kita pakai teknik polygon offset agar tidak flickering (z-fighting)
            const wireMat = new THREE.MeshBasicMaterial({ 
                color: 0x000000, 
                wireframe: true, 
                transparent: true, 
                opacity: 0.15 
            });
            const wireMesh = new THREE.Mesh(geometry, wireMat);
            mesh.add(wireMesh);

            // Rotasi agar sumbu Z matematika mengarah ke ATAS di dunia 3D
            mesh.rotation.x = -Math.PI / 2;
            
            scene.add(mesh);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        init();
    </script>
</body>
</html>
